#cloud-config

apt:
  preserve_sources_list: true
  sources:
    docker.list:
      source: "deb [arch=amd64] https://download.docker.com/linux/ubuntu $RELEASE stable"
      keyid: 0EBFCD88

chpasswd:
  expire: false

groups:
  - docker

package_reboot_if_required: true
package_update: true
package_upgrade: true
packages:
  - build-essential
  - docker-ce
  - inotify-tools
  - ocaml-nox
password: ubuntu

runcmd:
  - mkdir -p /home/cartolari/code
  - usermod -aG docker ubuntu

  - curl -L https://github.com/bcpierce00/unison/archive/2.48.4.tar.gz | tar zxv -C /tmp
  - cd /tmp/unison-2.48.4
  - sed -i -e 's/GLIBC_SUPPORT_INOTIFY 0/GLIBC_SUPPORT_INOTIFY 1/' src/fsmonitor/linux/inotify_stubs.c
  - make UISTYLE=text NATIVE=true STATIC=true
  - cp src/unison src/unison-fsmonitor /usr/local/bin
  - systemctl enable --now --no-block unison

ssh_pwauth: true

swap:
  filename: /swapfile
  maxsize: 2000000000
  size: "auto"

write_files:
  - content: |
      [Unit]
      Description=Unison File Synchronization
      After=network.target

      [Service]
      Type=Simple
      Environment="PATH=/sbin:/bin:/usr/bin:/usr/local/bin"
      ExecStart=/usr/local/bin/unison -socket 9090

      [Install]
      WantedBy=default.target
    path: /etc/systemd/system/unison.service

  - content: |
      [Service]
      ExecStart=
      ExecStart=/usr/bin/dockerd -H fd:// -H tcp://0.0.0.0:2376
    path: /etc/systemd/system/docker.service.d/startup_options.conf
