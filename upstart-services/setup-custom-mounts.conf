description "Allow executable files and bind mount /nix to the current user"
author      "bruno.cartolari@gmail.com"

start on start-user-session
task

script
  mount -o remount,rw /
  mount -o remount,exec /tmp
  mount -o remount,exec /mnt/stateful_partition
  mount -i -o remount,exec /home/chronos/user

  mkdir -p /nix
  mkdir -p /home/chronos/user/nix
  chown chronos:chronos /nix

  if ! mountpoint /nix &> /dev/null; then
    mount --bind /home/chronos/user/nix /nix
  fi

  sudo /home/chronos/user/.nix-profile/bin/cryptsetup luksOpen --key-file /home/chronos/user/.code-keyfile /mnt/stateful_partition/code.img
  sudo mount /dev/mapper/code /home/chronos/user/Downloads/code
end script
